/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Component, EventEmitter, ViewChild, ViewEncapsulation } from '@angular/core';
import { BehaviorSubject, AsyncSubject } from 'rxjs';
import jsQR from 'jsqr';
import { AS_COMPLETE, DRAW_RESULT, HAS_OWN_PROPERTY, OVERRIDES, PLAY_AUDIO } from './ngx-scanner-qrcode.helper';
import { CONFIG_DEFAULT, MEDIA_STREAM_DEFAULT } from './ngx-scanner-qrcode.default';
export class NgxScannerQrcodeComponent {
    constructor() {
        /**
         * EventEmitter
         */
        this.error = new EventEmitter();
        this.event = new EventEmitter();
        /**
         * Input
         */
        this.src = CONFIG_DEFAULT.src;
        this.isAuto = CONFIG_DEFAULT.isAuto;
        this.isBeep = CONFIG_DEFAULT.isBeep;
        this.isAlwaysEmit = CONFIG_DEFAULT.isAlwaysEmit;
        this.config = CONFIG_DEFAULT;
        this.medias = CONFIG_DEFAULT.medias;
        /**
         * Export
         */
        this.isStart = false;
        this.isLoading = false;
        this.data = new BehaviorSubject({});
    }
    /**
     * @return {?}
     */
    ngOnInit() {
        this.overrideConfig();
        if (this.src) {
            this.loadImage(this.src);
        }
        else if (this.isAuto) {
            this.start();
        }
        this.resize();
    }
    /**
     * start
     * @return {?} AsyncSubject
     */
    start() {
        /** @type {?} */
        const as = new AsyncSubject();
        if (this.isStart) {
            // Reject
            AS_COMPLETE(as, false);
        }
        else {
            // Loading on
            this.status(false, true);
            /**
             * MediaStream
             * Use facingMode: environment to attemt to get the front camera on phones
             */
            navigator.mediaDevices.getUserMedia(this.medias).then((/**
             * @param {?} stream
             * @return {?}
             */
            (stream) => {
                this.video.nativeElement.srcObject = stream;
                this.video.nativeElement.onloadedmetadata = (/**
                 * @return {?}
                 */
                () => {
                    this.video.nativeElement.play();
                    this.requestAnimationFrame();
                    this.status(true, false);
                    AS_COMPLETE(as, true);
                });
            })).catch((/**
             * @param {?} error
             * @return {?}
             */
            error => {
                this.status(false, false);
                this.eventEmit(false, error);
                AS_COMPLETE(as, false, error);
            }));
        }
        return as;
    }
    /**
     * stop
     * @return {?} AsyncSubject
     */
    stop() {
        this.eventEmit(null);
        this.status(false, false);
        /** @type {?} */
        const as = new AsyncSubject();
        try {
            this.removeCanvas();
            clearInterval(this.rAF_ID);
            ((/** @type {?} */ (this.video.nativeElement.srcObject))).getTracks().forEach((/**
             * @param {?} track
             * @return {?}
             */
            (track) => {
                track.stop();
                AS_COMPLETE(as, true);
            }));
        }
        catch (error) {
            this.eventEmit(false, error);
            AS_COMPLETE(as, false, (/** @type {?} */ (error)));
        }
        return as;
    }
    /**
     * play
     * @return {?} AsyncSubject
     */
    play() {
        /** @type {?} */
        const as = new AsyncSubject();
        if (this.isPause) {
            this.video.nativeElement.play();
            this.requestAnimationFrame();
            AS_COMPLETE(as, true);
        }
        else {
            AS_COMPLETE(as, false);
        }
        return as;
    }
    /**
     * pause
     * @return {?} AsyncSubject
     */
    pause() {
        /** @type {?} */
        const as = new AsyncSubject();
        if (this.isStart) {
            clearInterval(this.rAF_ID);
            this.video.nativeElement.pause();
            AS_COMPLETE(as, true);
        }
        else {
            AS_COMPLETE(as, false);
        }
        return as;
    }
    /**
     * loadImage
     * @param {?} src
     * @return {?}
     */
    loadImage(src) {
        /** @type {?} */
        const as = new AsyncSubject();
        // Loading on
        this.status(false, true);
        // Set the src of this Image object.
        /** @type {?} */
        const image = new Image();
        // Setting cross origin value to anonymous
        image.setAttribute('crossOrigin', 'anonymous');
        // When our image has loaded.
        image.onload = (/**
         * @return {?}
         */
        () => {
            this.drawImage(image, (/**
             * @param {?} flag
             * @return {?}
             */
            (flag) => {
                this.status(false, false);
                AS_COMPLETE(as, flag);
            }));
        });
        // Set src
        image.src = src;
        return as;
    }
    /**
     * window: resize
     * Draw again!
     * @private
     * @return {?}
     */
    resize() {
        window.addEventListener("resize", (/**
         * @return {?}
         */
        () => this.data.subscribe((/**
         * @param {?} res
         * @return {?}
         */
        res => {
            if (HAS_OWN_PROPERTY(res, 'location')) {
                DRAW_RESULT((/** @type {?} */ (res)), this.canvas.nativeElement, this.resultsPanel.nativeElement);
            }
        }))));
    }
    /**
     * Override config
     * @private
     * @return {?} void
     */
    overrideConfig() {
        if (HAS_OWN_PROPERTY(this.config, 'src'))
            this.src = this.config.src;
        if (HAS_OWN_PROPERTY(this.config, 'isAuto'))
            this.isAuto = this.config.isAuto;
        if (HAS_OWN_PROPERTY(this.config, 'isBeep'))
            this.isBeep = this.config.isBeep;
        if (HAS_OWN_PROPERTY(this.config, 'isAlwaysEmit'))
            this.isAlwaysEmit = this.config.isAlwaysEmit;
        if (HAS_OWN_PROPERTY(this.config, 'medias'))
            this.medias = OVERRIDES('medias', this.config, MEDIA_STREAM_DEFAULT);
    }
    /**
     * drawImage
     * @private
     * @param {?} element
     * @param {?=} callback
     * @return {?}
     */
    drawImage(element, callback = (/**
     * @return {?}
     */
    () => { })) {
        // Get the canvas element by using the getElementById method.
        /** @type {?} */
        const canvas = this.canvas.nativeElement;
        // Get a 2D drawing context for the canvas.
        /** @type {?} */
        const ctx = (/** @type {?} */ (canvas.getContext('2d', { willReadFrequently: true })));
        // HTMLImageElement size
        if (element instanceof HTMLImageElement) {
            canvas.width = element.naturalWidth;
            canvas.height = element.naturalHeight;
            element.style.visibility = '';
            this.video.nativeElement.style.visibility = 'hidden';
        }
        // HTMLVideoElement size
        if (element instanceof HTMLVideoElement) {
            canvas.width = element.videoWidth;
            canvas.height = element.videoHeight;
            element.style.visibility = '';
            this.canvas.nativeElement.style.visibility = 'hidden';
        }
        // Draw image
        ctx.drawImage(element, 0, 0, canvas.width, canvas.height);
        // Data image
        /** @type {?} */
        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        // Draw frame
        /** @type {?} */
        const code = jsQR(imageData.data, imageData.width, imageData.height, { inversionAttempts: "attemptBoth" });
        if (code) {
            DRAW_RESULT(code, Object.freeze(this.canvas.nativeElement), this.resultsPanel.nativeElement);
            // toBlob and emit data
            /** @type {?} */
            const EMIT_DATA = (/**
             * @return {?}
             */
            () => this.eventEmit(Object.assign({}, code, { canvas: canvas })));
            // HTMLImageElement
            if (element instanceof HTMLImageElement) {
                callback(true);
                EMIT_DATA();
                PLAY_AUDIO(this.isBeep);
            }
            // HTMLVideoElement
            if (element instanceof HTMLVideoElement) {
                if (this.isAlwaysEmit) {
                    EMIT_DATA();
                    PLAY_AUDIO(this.isBeep);
                }
                else if (code.data !== ((/** @type {?} */ (this.data.value)))['data']) {
                    EMIT_DATA();
                    PLAY_AUDIO(this.isBeep);
                }
            }
        }
        else {
            callback(false);
            this.removeCanvas();
        }
    }
    /**
     * removeCanvas
     * @private
     * @return {?}
     */
    removeCanvas() {
        Object.assign([], this.resultsPanel.nativeElement.childNodes).forEach((/**
         * @param {?} el
         * @return {?}
         */
        el => this.resultsPanel.nativeElement.removeChild(el)));
    }
    /**
     * status
     * @private
     * @param {?} isStart
     * @param {?} isLoading
     * @return {?}
     */
    status(isStart, isLoading) {
        this.isStart = isStart;
        this.isLoading = isLoading;
    }
    /**
     * eventEmit
     * @private
     * @param {?=} response
     * @param {?=} error
     * @return {?}
     */
    eventEmit(response = false, error = false) {
        (response !== false) && this.data.next(response || { data: null });
        (response !== false) && this.event.emit(response || { data: null });
        (error !== false) && this.error.emit(error || null);
    }
    /**
     * Single-thread
     * Loop Recording on Camera
     * Must be destroy request
     * requestAnimationFrame
     * @private
     * @return {?}
     */
    requestAnimationFrame() {
        this.rAF_ID = setInterval((/**
         * @return {?}
         */
        () => {
            if (this.video.nativeElement.readyState === this.video.nativeElement.HAVE_ENOUGH_DATA) {
                this.drawImage(this.video.nativeElement);
            }
        }), 40);
    }
    /**
     * Status of camera
     * @return {?} boolean
     */
    get isPause() {
        return this.isStart && this.video.nativeElement.paused;
    }
    /**
     * @return {?}
     */
    ngOnDestroy() {
        this.pause();
    }
}
NgxScannerQrcodeComponent.decorators = [
    { type: Component, args: [{
                selector: 'ngx-scanner-qrcode',
                template: "<div #resultsPanel class=\"origin-overlay\"></div>\r\n<canvas #canvas class=\"origin-canvas\"></canvas>\r\n<video #video playsinline class=\"origin-video\"></video>",
                host: { 'class': 'ngx-scanner-qrcode' },
                exportAs: 'scanner',
                inputs: ['src', 'isAuto', 'isBeep', 'isAlwaysEmit', 'config', 'medias'],
                outputs: ['event', 'error'],
                queries: {
                    video: new ViewChild('video'),
                    canvas: new ViewChild('canvas'),
                    resultsPanel: new ViewChild('resultsPanel')
                },
                encapsulation: ViewEncapsulation.None,
                styles: [".ngx-scanner-qrcode{width:100%;position:relative;background-color:#262626;display:flex;justify-content:center;align-items:center}.origin-overlay{position:absolute;width:100%;height:100%}.origin-canvas{-o-object-fit:contain;object-fit:contain;position:absolute;width:100%;height:100%}.origin-video{width:100%;height:100%}.qrcode-tooltip{position:absolute;z-index:2}.qrcode-tooltip:hover .qrcode-tooltip-temp{display:block;position:absolute}.qrcode-tooltip-temp{bottom:0;z-index:3;left:50%;padding:10px;display:none;width:-moz-max-content;width:max-content;word-wrap:break-word;max-width:450px;box-shadow:1px 1px 20px #000000e0;border-radius:5px;background-color:#000000d0;transform:translate(-50%);transform-style:preserve-3d;color:#fff;text-align:left}.qrcode-data{position:absolute;top:-20px;color:red}"]
            }] }
];
if (false) {
    /**
     * Element
     * playsinline required to tell iOS safari we don't want fullscreen
     * @type {?}
     */
    NgxScannerQrcodeComponent.prototype.video;
    /** @type {?} */
    NgxScannerQrcodeComponent.prototype.canvas;
    /** @type {?} */
    NgxScannerQrcodeComponent.prototype.resultsPanel;
    /**
     * EventEmitter
     * @type {?}
     */
    NgxScannerQrcodeComponent.prototype.error;
    /** @type {?} */
    NgxScannerQrcodeComponent.prototype.event;
    /**
     * Input
     * @type {?}
     */
    NgxScannerQrcodeComponent.prototype.src;
    /** @type {?} */
    NgxScannerQrcodeComponent.prototype.isAuto;
    /** @type {?} */
    NgxScannerQrcodeComponent.prototype.isBeep;
    /** @type {?} */
    NgxScannerQrcodeComponent.prototype.isAlwaysEmit;
    /** @type {?} */
    NgxScannerQrcodeComponent.prototype.config;
    /** @type {?} */
    NgxScannerQrcodeComponent.prototype.medias;
    /**
     * Export
     * @type {?}
     */
    NgxScannerQrcodeComponent.prototype.isStart;
    /** @type {?} */
    NgxScannerQrcodeComponent.prototype.isLoading;
    /** @type {?} */
    NgxScannerQrcodeComponent.prototype.data;
    /**
     * Private
     * @type {?}
     * @private
     */
    NgxScannerQrcodeComponent.prototype.rAF_ID;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibmd4LXNjYW5uZXItcXJjb2RlLmNvbXBvbmVudC5qcyIsInNvdXJjZVJvb3QiOiJuZzovL25neC1zY2FubmVyLXFyY29kZS8iLCJzb3VyY2VzIjpbImxpYi9uZ3gtc2Nhbm5lci1xcmNvZGUuY29tcG9uZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7QUFBQSxPQUFPLEVBQUUsU0FBUyxFQUFjLFlBQVksRUFBcUIsU0FBUyxFQUFFLGlCQUFpQixFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQ3JILE9BQU8sRUFBRSxlQUFlLEVBQUUsWUFBWSxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQ3JELE9BQU8sSUFBSSxNQUFNLE1BQU0sQ0FBQztBQUN4QixPQUFPLEVBQUUsV0FBVyxFQUFFLFdBQVcsRUFBRSxnQkFBZ0IsRUFBRSxTQUFTLEVBQUUsVUFBVSxFQUFFLE1BQU0sNkJBQTZCLENBQUM7QUFFaEgsT0FBTyxFQUFFLGNBQWMsRUFBRSxvQkFBb0IsRUFBRSxNQUFNLDhCQUE4QixDQUFDO0FBa0JwRixNQUFNO0lBZk47UUF5QkU7O1dBRUc7UUFDSSxVQUFLLEdBQUcsSUFBSSxZQUFZLEVBQWMsQ0FBQztRQUN2QyxVQUFLLEdBQUcsSUFBSSxZQUFZLEVBQXVCLENBQUM7UUFFdkQ7O1dBRUc7UUFDSSxRQUFHLEdBQXVCLGNBQWMsQ0FBQyxHQUFHLENBQUM7UUFDN0MsV0FBTSxHQUF3QixjQUFjLENBQUMsTUFBTSxDQUFDO1FBQ3BELFdBQU0sR0FBd0IsY0FBYyxDQUFDLE1BQU0sQ0FBQztRQUNwRCxpQkFBWSxHQUF3QixjQUFjLENBQUMsWUFBWSxDQUFDO1FBQ2hFLFdBQU0sR0FBZSxjQUFjLENBQUM7UUFDcEMsV0FBTSxHQUF1QyxjQUFjLENBQUMsTUFBTSxDQUFDO1FBRTFFOztXQUVHO1FBQ0ksWUFBTyxHQUFZLEtBQUssQ0FBQztRQUN6QixjQUFTLEdBQVksS0FBSyxDQUFDO1FBQzNCLFNBQUksR0FBRyxJQUFJLGVBQWUsQ0FBc0IsRUFBRSxDQUFDLENBQUM7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MENBQXVEOzs7OztJQUt2RCx3Q0FBb0Q7O0lBQ3BELDJDQUEyRDs7SUFDM0QsMkNBQTJEOztJQUMzRCxpREFBdUU7O0lBQ3ZFLDJDQUEyQzs7SUFDM0MsMkNBQTBFOzs7OztJQUsxRSw0Q0FBZ0M7O0lBQ2hDLDhDQUFrQzs7SUFDbEMseUNBQTJEOzs7Ozs7SUFLM0QsMkNBQW9CIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQ29tcG9uZW50LCBFbGVtZW50UmVmLCBFdmVudEVtaXR0ZXIsIE9uRGVzdHJveSwgT25Jbml0LCBWaWV3Q2hpbGQsIFZpZXdFbmNhcHN1bGF0aW9uIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCB7IEJlaGF2aW9yU3ViamVjdCwgQXN5bmNTdWJqZWN0IH0gZnJvbSAncnhqcyc7XHJcbmltcG9ydCBqc1FSIGZyb20gJ2pzcXInO1xyXG5pbXBvcnQgeyBBU19DT01QTEVURSwgRFJBV19SRVNVTFQsIEhBU19PV05fUFJPUEVSVFksIE9WRVJSSURFUywgUExBWV9BVURJTyB9IGZyb20gJy4vbmd4LXNjYW5uZXItcXJjb2RlLmhlbHBlcic7XHJcbmltcG9ydCB7IEJhc2VDb25maWcsIFNjYW5uZXJRUkNvZGVSZXN1bHQgfSBmcm9tICcuL25neC1zY2FubmVyLXFyY29kZS5vcHRpb25zJztcclxuaW1wb3J0IHsgQ09ORklHX0RFRkFVTFQsIE1FRElBX1NUUkVBTV9ERUZBVUxUIH0gZnJvbSAnLi9uZ3gtc2Nhbm5lci1xcmNvZGUuZGVmYXVsdCc7XHJcblxyXG5cclxuQENvbXBvbmVudCh7XHJcbiAgc2VsZWN0b3I6ICduZ3gtc2Nhbm5lci1xcmNvZGUnLFxyXG4gIHRlbXBsYXRlVXJsOiAnLi9uZ3gtc2Nhbm5lci1xcmNvZGUuY29tcG9uZW50Lmh0bWwnLFxyXG4gIHN0eWxlVXJsczogWycuL25neC1zY2FubmVyLXFyY29kZS5jb21wb25lbnQuc2NzcyddLFxyXG4gIGhvc3Q6IHsgJ2NsYXNzJzogJ25neC1zY2FubmVyLXFyY29kZScgfSxcclxuICBleHBvcnRBczogJ3NjYW5uZXInLFxyXG4gIGlucHV0czogWydzcmMnLCAnaXNBdXRvJywgJ2lzQmVlcCcsICdpc0Fsd2F5c0VtaXQnLCAnY29uZmlnJywgJ21lZGlhcyddLFxyXG4gIG91dHB1dHM6IFsnZXZlbnQnLCAnZXJyb3InXSxcclxuICBxdWVyaWVzOiB7XHJcbiAgICB2aWRlbzogbmV3IFZpZXdDaGlsZCgndmlkZW8nKSxcclxuICAgIGNhbnZhczogbmV3IFZpZXdDaGlsZCgnY2FudmFzJyksXHJcbiAgICByZXN1bHRzUGFuZWw6IG5ldyBWaWV3Q2hpbGQoJ3Jlc3VsdHNQYW5lbCcpXHJcbiAgfSxcclxuICBlbmNhcHN1bGF0aW9uOiBWaWV3RW5jYXBzdWxhdGlvbi5Ob25lXHJcbn0pXHJcbmV4cG9ydCBjbGFzcyBOZ3hTY2FubmVyUXJjb2RlQ29tcG9uZW50IGltcGxlbWVudHMgT25Jbml0LCBPbkRlc3Ryb3kge1xyXG5cclxuICAvKipcclxuICAgKiBFbGVtZW50XHJcbiAgICogcGxheXNpbmxpbmUgcmVxdWlyZWQgdG8gdGVsbCBpT1Mgc2FmYXJpIHdlIGRvbid0IHdhbnQgZnVsbHNjcmVlblxyXG4gICAqL1xyXG4gIHB1YmxpYyB2aWRlbyE6IEVsZW1lbnRSZWY8SFRNTFZpZGVvRWxlbWVudD47XHJcbiAgcHVibGljIGNhbnZhcyE6IEVsZW1lbnRSZWY8SFRNTENhbnZhc0VsZW1lbnQ+O1xyXG4gIHB1YmxpYyByZXN1bHRzUGFuZWwhOiBFbGVtZW50UmVmPEhUTUxEaXZFbGVtZW50PjtcclxuXHJcbiAgLyoqXHJcbiAgICogRXZlbnRFbWl0dGVyXHJcbiAgICovXHJcbiAgcHVibGljIGVycm9yID0gbmV3IEV2ZW50RW1pdHRlcjxhbnkgfCBudWxsPigpO1xyXG4gIHB1YmxpYyBldmVudCA9IG5ldyBFdmVudEVtaXR0ZXI8U2Nhbm5lclFSQ29kZVJlc3VsdD4oKTtcclxuXHJcbiAgLyoqXHJcbiAgICogSW5wdXRcclxuICAgKi9cclxuICBwdWJsaWMgc3JjOiBzdHJpbmcgfCB1bmRlZmluZWQgPSBDT05GSUdfREVGQVVMVC5zcmM7XHJcbiAgcHVibGljIGlzQXV0bzogYm9vbGVhbiB8IHVuZGVmaW5lZCA9IENPTkZJR19ERUZBVUxULmlzQXV0bztcclxuICBwdWJsaWMgaXNCZWVwOiBib29sZWFuIHwgdW5kZWZpbmVkID0gQ09ORklHX0RFRkFVTFQuaXNCZWVwO1xyXG4gIHB1YmxpYyBpc0Fsd2F5c0VtaXQ6IGJvb2xlYW4gfCB1bmRlZmluZWQgPSBDT05GSUdfREVGQVVMVC5pc0Fsd2F5c0VtaXQ7XHJcbiAgcHVibGljIGNvbmZpZzogQmFzZUNvbmZpZyA9IENPTkZJR19ERUZBVUxUO1xyXG4gIHB1YmxpYyBtZWRpYXM6IE1lZGlhU3RyZWFtQ29uc3RyYWludHMgfCB1bmRlZmluZWQgPSBDT05GSUdfREVGQVVMVC5tZWRpYXM7XHJcblxyXG4gIC8qKlxyXG4gICAqIEV4cG9ydFxyXG4gICAqL1xyXG4gIHB1YmxpYyBpc1N0YXJ0OiBib29sZWFuID0gZmFsc2U7XHJcbiAgcHVibGljIGlzTG9hZGluZzogYm9vbGVhbiA9IGZhbHNlO1xyXG4gIHB1YmxpYyBkYXRhID0gbmV3IEJlaGF2aW9yU3ViamVjdDxTY2FubmVyUVJDb2RlUmVzdWx0Pih7fSk7XHJcblxyXG4gIC8qKlxyXG4gICAqIFByaXZhdGVcclxuICAgKi9cclxuICBwcml2YXRlIHJBRl9JRDogYW55O1xyXG5cclxuICBuZ09uSW5pdCgpOiB2b2lkIHtcclxuICAgIHRoaXMub3ZlcnJpZGVDb25maWcoKTtcclxuICAgIGlmICh0aGlzLnNyYykge1xyXG4gICAgICB0aGlzLmxvYWRJbWFnZSh0aGlzLnNyYyk7XHJcbiAgICB9IGVsc2UgaWYgKHRoaXMuaXNBdXRvKSB7XHJcbiAgICAgIHRoaXMuc3RhcnQoKTtcclxuICAgIH1cclxuICAgIHRoaXMucmVzaXplKCk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBzdGFydFxyXG4gICAqIEByZXR1cm4gQXN5bmNTdWJqZWN0XHJcbiAgICovXHJcbiAgcHVibGljIHN0YXJ0KCk6IEFzeW5jU3ViamVjdDxhbnk+IHtcclxuICAgIGNvbnN0IGFzID0gbmV3IEFzeW5jU3ViamVjdDxhbnk+KCk7XHJcbiAgICBpZiAodGhpcy5pc1N0YXJ0KSB7XHJcbiAgICAgIC8vIFJlamVjdFxyXG4gICAgICBBU19DT01QTEVURShhcywgZmFsc2UpO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgLy8gTG9hZGluZyBvblxyXG4gICAgICB0aGlzLnN0YXR1cyhmYWxzZSwgdHJ1ZSk7XHJcbiAgICAgIC8qKlxyXG4gICAgICAgKiBNZWRpYVN0cmVhbVxyXG4gICAgICAgKiBVc2UgZmFjaW5nTW9kZTogZW52aXJvbm1lbnQgdG8gYXR0ZW10IHRvIGdldCB0aGUgZnJvbnQgY2FtZXJhIG9uIHBob25lc1xyXG4gICAgICAgKi9cclxuICAgICAgbmF2aWdhdG9yLm1lZGlhRGV2aWNlcy5nZXRVc2VyTWVkaWEodGhpcy5tZWRpYXMpLnRoZW4oKHN0cmVhbTogTWVkaWFTdHJlYW0pID0+IHtcclxuICAgICAgICB0aGlzLnZpZGVvLm5hdGl2ZUVsZW1lbnQuc3JjT2JqZWN0ID0gc3RyZWFtO1xyXG4gICAgICAgIHRoaXMudmlkZW8ubmF0aXZlRWxlbWVudC5vbmxvYWRlZG1ldGFkYXRhID0gKCkgPT4ge1xyXG4gICAgICAgICAgdGhpcy52aWRlby5uYXRpdmVFbGVtZW50LnBsYXkoKTtcclxuICAgICAgICAgIHRoaXMucmVxdWVzdEFuaW1hdGlvbkZyYW1lKCk7XHJcbiAgICAgICAgICB0aGlzLnN0YXR1cyh0cnVlLCBmYWxzZSk7XHJcbiAgICAgICAgICBBU19DT01QTEVURShhcywgdHJ1ZSk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9KS5jYXRjaChlcnJvciA9PiB7XHJcbiAgICAgICAgdGhpcy5zdGF0dXMoZmFsc2UsIGZhbHNlKTtcclxuICAgICAgICB0aGlzLmV2ZW50RW1pdChmYWxzZSwgZXJyb3IpO1xyXG4gICAgICAgIEFTX0NPTVBMRVRFKGFzLCBmYWxzZSwgZXJyb3IpO1xyXG4gICAgICB9KTtcclxuICAgIH1cclxuXHJcbiAgICByZXR1cm4gYXM7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBzdG9wXHJcbiAgICogQHJldHVybiBBc3luY1N1YmplY3RcclxuICAgKi9cclxuICBwdWJsaWMgc3RvcCgpOiBBc3luY1N1YmplY3Q8YW55PiB7XHJcbiAgICB0aGlzLmV2ZW50RW1pdChudWxsKTtcclxuICAgIHRoaXMuc3RhdHVzKGZhbHNlLCBmYWxzZSk7XHJcbiAgICBjb25zdCBhcyA9IG5ldyBBc3luY1N1YmplY3Q8YW55PigpO1xyXG4gICAgdHJ5IHtcclxuICAgICAgdGhpcy5yZW1vdmVDYW52YXMoKTtcclxuICAgICAgY2xlYXJJbnRlcnZhbCh0aGlzLnJBRl9JRCk7XHJcbiAgICAgICh0aGlzLnZpZGVvLm5hdGl2ZUVsZW1lbnQuc3JjT2JqZWN0IGFzIE1lZGlhU3RyZWFtKS5nZXRUcmFja3MoKS5mb3JFYWNoKCh0cmFjazogYW55KSA9PiB7XHJcbiAgICAgICAgdHJhY2suc3RvcCgpO1xyXG4gICAgICAgIEFTX0NPTVBMRVRFKGFzLCB0cnVlKTtcclxuICAgICAgfSk7XHJcbiAgICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgICB0aGlzLmV2ZW50RW1pdChmYWxzZSwgZXJyb3IpO1xyXG4gICAgICBBU19DT01QTEVURShhcywgZmFsc2UsIGVycm9yIGFzIGFueSk7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gYXM7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBwbGF5XHJcbiAgICogQHJldHVybiBBc3luY1N1YmplY3RcclxuICAgKi9cclxuICBwdWJsaWMgcGxheSgpOiBBc3luY1N1YmplY3Q8YW55PiB7XHJcbiAgICBjb25zdCBhcyA9IG5ldyBBc3luY1N1YmplY3Q8YW55PigpO1xyXG4gICAgaWYgKHRoaXMuaXNQYXVzZSkge1xyXG4gICAgICB0aGlzLnZpZGVvLm5hdGl2ZUVsZW1lbnQucGxheSgpO1xyXG4gICAgICB0aGlzLnJlcXVlc3RBbmltYXRpb25GcmFtZSgpO1xyXG4gICAgICBBU19DT01QTEVURShhcywgdHJ1ZSk7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICBBU19DT01QTEVURShhcywgZmFsc2UpO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIGFzO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogcGF1c2VcclxuICAgKiBAcmV0dXJuIEFzeW5jU3ViamVjdCBcclxuICAgKi9cclxuICBwdWJsaWMgcGF1c2UoKTogQXN5bmNTdWJqZWN0PGFueT4ge1xyXG4gICAgY29uc3QgYXMgPSBuZXcgQXN5bmNTdWJqZWN0PGFueT4oKTtcclxuICAgIGlmICh0aGlzLmlzU3RhcnQpIHtcclxuICAgICAgY2xlYXJJbnRlcnZhbCh0aGlzLnJBRl9JRCk7XHJcbiAgICAgIHRoaXMudmlkZW8ubmF0aXZlRWxlbWVudC5wYXVzZSgpO1xyXG4gICAgICBBU19DT01QTEVURShhcywgdHJ1ZSk7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICBBU19DT01QTEVURShhcywgZmFsc2UpO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIGFzO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogbG9hZEltYWdlXHJcbiAgICogQHBhcmFtIHNyYyBcclxuICAgKi9cclxuICBwdWJsaWMgbG9hZEltYWdlKHNyYzogc3RyaW5nKTogQXN5bmNTdWJqZWN0PGFueT4ge1xyXG4gICAgY29uc3QgYXMgPSBuZXcgQXN5bmNTdWJqZWN0PGFueT4oKTtcclxuICAgIC8vIExvYWRpbmcgb25cclxuICAgIHRoaXMuc3RhdHVzKGZhbHNlLCB0cnVlKTtcclxuICAgIC8vIFNldCB0aGUgc3JjIG9mIHRoaXMgSW1hZ2Ugb2JqZWN0LlxyXG4gICAgY29uc3QgaW1hZ2UgPSBuZXcgSW1hZ2UoKTtcclxuICAgIC8vIFNldHRpbmcgY3Jvc3Mgb3JpZ2luIHZhbHVlIHRvIGFub255bW91c1xyXG4gICAgaW1hZ2Uuc2V0QXR0cmlidXRlKCdjcm9zc09yaWdpbicsICdhbm9ueW1vdXMnKTtcclxuICAgIC8vIFdoZW4gb3VyIGltYWdlIGhhcyBsb2FkZWQuXHJcbiAgICBpbWFnZS5vbmxvYWQgPSAoKSA9PiB7XHJcbiAgICAgIHRoaXMuZHJhd0ltYWdlKGltYWdlLCAoZmxhZzogYm9vbGVhbikgPT4geyBcclxuICAgICAgICB0aGlzLnN0YXR1cyhmYWxzZSwgZmFsc2UpO1xyXG4gICAgICAgIEFTX0NPTVBMRVRFKGFzLCBmbGFnKTtcclxuICAgICAgfSk7XHJcbiAgICB9O1xyXG4gICAgLy8gU2V0IHNyY1xyXG4gICAgaW1hZ2Uuc3JjID0gc3JjO1xyXG4gICAgcmV0dXJuIGFzO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogd2luZG93OiByZXNpemVcclxuICAgKiBEcmF3IGFnYWluIVxyXG4gICAqL1xyXG4gIHByaXZhdGUgcmVzaXplKCk6IHZvaWQge1xyXG4gICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoXCJyZXNpemVcIiwgKCkgPT4gdGhpcy5kYXRhLnN1YnNjcmliZShyZXMgPT4ge1xyXG4gICAgICBpZiAoSEFTX09XTl9QUk9QRVJUWShyZXMsICdsb2NhdGlvbicpKSB7XHJcbiAgICAgICAgRFJBV19SRVNVTFQocmVzIGFzIGFueSwgdGhpcy5jYW52YXMubmF0aXZlRWxlbWVudCwgdGhpcy5yZXN1bHRzUGFuZWwubmF0aXZlRWxlbWVudCk7XHJcbiAgICAgIH0gXHJcbiAgICB9KSk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBPdmVycmlkZSBjb25maWdcclxuICAgKiBAcmV0dXJuIHZvaWRcclxuICAgKi9cclxuICBwcml2YXRlIG92ZXJyaWRlQ29uZmlnKCk6IHZvaWQge1xyXG4gICAgaWYgKEhBU19PV05fUFJPUEVSVFkodGhpcy5jb25maWcsICdzcmMnKSkgdGhpcy5zcmMgPSB0aGlzLmNvbmZpZy5zcmM7XHJcbiAgICBpZiAoSEFTX09XTl9QUk9QRVJUWSh0aGlzLmNvbmZpZywgJ2lzQXV0bycpKSB0aGlzLmlzQXV0byA9IHRoaXMuY29uZmlnLmlzQXV0bztcclxuICAgIGlmIChIQVNfT1dOX1BST1BFUlRZKHRoaXMuY29uZmlnLCAnaXNCZWVwJykpIHRoaXMuaXNCZWVwID0gdGhpcy5jb25maWcuaXNCZWVwO1xyXG4gICAgaWYgKEhBU19PV05fUFJPUEVSVFkodGhpcy5jb25maWcsICdpc0Fsd2F5c0VtaXQnKSkgdGhpcy5pc0Fsd2F5c0VtaXQgPSB0aGlzLmNvbmZpZy5pc0Fsd2F5c0VtaXQ7XHJcbiAgICBpZiAoSEFTX09XTl9QUk9QRVJUWSh0aGlzLmNvbmZpZywgJ21lZGlhcycpKSB0aGlzLm1lZGlhcyA9IE9WRVJSSURFUygnbWVkaWFzJywgdGhpcy5jb25maWcsIE1FRElBX1NUUkVBTV9ERUZBVUxUKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIGRyYXdJbWFnZVxyXG4gICAqIEBwYXJhbSBlbGVtZW50IFxyXG4gICAqIEBwYXJhbSBjYWxsYmFjayBcclxuICAgKi9cclxuICBwcml2YXRlIGRyYXdJbWFnZShlbGVtZW50OiBIVE1MSW1hZ2VFbGVtZW50IHwgSFRNTFZpZGVvRWxlbWVudCwgY2FsbGJhY2s6IEZ1bmN0aW9uID0gKCkgPT4ge30pOiB2b2lkIHtcclxuICAgIC8vIEdldCB0aGUgY2FudmFzIGVsZW1lbnQgYnkgdXNpbmcgdGhlIGdldEVsZW1lbnRCeUlkIG1ldGhvZC5cclxuICAgIGNvbnN0IGNhbnZhcyA9IHRoaXMuY2FudmFzLm5hdGl2ZUVsZW1lbnQ7XHJcbiAgICAvLyBHZXQgYSAyRCBkcmF3aW5nIGNvbnRleHQgZm9yIHRoZSBjYW52YXMuXHJcbiAgICBjb25zdCBjdHggPSBjYW52YXMuZ2V0Q29udGV4dCgnMmQnLCB7IHdpbGxSZWFkRnJlcXVlbnRseTogdHJ1ZSB9KSBhcyBDYW52YXNSZW5kZXJpbmdDb250ZXh0MkQ7XHJcbiAgICAvLyBIVE1MSW1hZ2VFbGVtZW50IHNpemVcclxuICAgIGlmIChlbGVtZW50IGluc3RhbmNlb2YgSFRNTEltYWdlRWxlbWVudCkge1xyXG4gICAgICBjYW52YXMud2lkdGggPSBlbGVtZW50Lm5hdHVyYWxXaWR0aDtcclxuICAgICAgY2FudmFzLmhlaWdodCA9IGVsZW1lbnQubmF0dXJhbEhlaWdodDtcclxuICAgICAgZWxlbWVudC5zdHlsZS52aXNpYmlsaXR5ID0gJyc7XHJcbiAgICAgIHRoaXMudmlkZW8ubmF0aXZlRWxlbWVudC5zdHlsZS52aXNpYmlsaXR5ID0gJ2hpZGRlbic7XHJcbiAgICB9XHJcbiAgICAvLyBIVE1MVmlkZW9FbGVtZW50IHNpemVcclxuICAgIGlmIChlbGVtZW50IGluc3RhbmNlb2YgSFRNTFZpZGVvRWxlbWVudCkge1xyXG4gICAgICBjYW52YXMud2lkdGggPSBlbGVtZW50LnZpZGVvV2lkdGg7XHJcbiAgICAgIGNhbnZhcy5oZWlnaHQgPSBlbGVtZW50LnZpZGVvSGVpZ2h0O1xyXG4gICAgICBlbGVtZW50LnN0eWxlLnZpc2liaWxpdHkgPSAnJztcclxuICAgICAgdGhpcy5jYW52YXMubmF0aXZlRWxlbWVudC5zdHlsZS52aXNpYmlsaXR5ID0gJ2hpZGRlbic7XHJcbiAgICB9XHJcbiAgICAvLyBEcmF3IGltYWdlXHJcbiAgICBjdHguZHJhd0ltYWdlKGVsZW1lbnQsIDAsIDAsIGNhbnZhcy53aWR0aCwgY2FudmFzLmhlaWdodCk7XHJcbiAgICAvLyBEYXRhIGltYWdlXHJcbiAgICBjb25zdCBpbWFnZURhdGEgPSBjdHguZ2V0SW1hZ2VEYXRhKDAsIDAsIGNhbnZhcy53aWR0aCwgY2FudmFzLmhlaWdodCk7XHJcbiAgICAvLyBEcmF3IGZyYW1lXHJcbiAgICBjb25zdCBjb2RlID0ganNRUihpbWFnZURhdGEuZGF0YSwgaW1hZ2VEYXRhLndpZHRoLCBpbWFnZURhdGEuaGVpZ2h0LCB7IGludmVyc2lvbkF0dGVtcHRzOiBcImF0dGVtcHRCb3RoXCIgfSk7IC8qIFwiZG9udEludmVydFwiIHwgXCJvbmx5SW52ZXJ0XCIgfCBcImF0dGVtcHRCb3RoXCIgfCBcImludmVydEZpcnN0XCIgKi9cclxuICAgIGlmIChjb2RlKSB7XHJcbiAgICAgIERSQVdfUkVTVUxUKGNvZGUsIE9iamVjdC5mcmVlemUodGhpcy5jYW52YXMubmF0aXZlRWxlbWVudCksIHRoaXMucmVzdWx0c1BhbmVsLm5hdGl2ZUVsZW1lbnQpO1xyXG5cclxuICAgICAgLy8gdG9CbG9iIGFuZCBlbWl0IGRhdGFcclxuICAgICAgY29uc3QgRU1JVF9EQVRBID0gKCkgPT4gdGhpcy5ldmVudEVtaXQoey4uLmNvZGUsIGNhbnZhczogY2FudmFzfSk7XHJcbiAgICAgXHJcbiAgICAgIC8vIEhUTUxJbWFnZUVsZW1lbnRcclxuICAgICAgaWYgKGVsZW1lbnQgaW5zdGFuY2VvZiBIVE1MSW1hZ2VFbGVtZW50KSB7XHJcbiAgICAgICAgY2FsbGJhY2sodHJ1ZSk7XHJcbiAgICAgICAgRU1JVF9EQVRBKCk7XHJcbiAgICAgICAgUExBWV9BVURJTyh0aGlzLmlzQmVlcCk7XHJcbiAgICAgIH0gXHJcbiAgICAgIC8vIEhUTUxWaWRlb0VsZW1lbnRcclxuICAgICAgaWYgKGVsZW1lbnQgaW5zdGFuY2VvZiBIVE1MVmlkZW9FbGVtZW50KSB7XHJcbiAgICAgICAgaWYgKHRoaXMuaXNBbHdheXNFbWl0KSB7XHJcbiAgICAgICAgICBFTUlUX0RBVEEoKTtcclxuICAgICAgICAgIFBMQVlfQVVESU8odGhpcy5pc0JlZXApO1xyXG4gICAgICAgIH0gZWxzZSBpZiAoY29kZS5kYXRhICE9PSAodGhpcy5kYXRhLnZhbHVlIGFzIGFueSlbJ2RhdGEnXSkge1xyXG4gICAgICAgICAgRU1JVF9EQVRBKCk7XHJcbiAgICAgICAgICBQTEFZX0FVRElPKHRoaXMuaXNCZWVwKTtcclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIGNhbGxiYWNrKGZhbHNlKTtcclxuICAgICAgdGhpcy5yZW1vdmVDYW52YXMoKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIHJlbW92ZUNhbnZhc1xyXG4gICAqL1xyXG4gIHByaXZhdGUgcmVtb3ZlQ2FudmFzKCk6IHZvaWQge1xyXG4gICAgT2JqZWN0LmFzc2lnbihbXSwgdGhpcy5yZXN1bHRzUGFuZWwubmF0aXZlRWxlbWVudC5jaGlsZE5vZGVzKS5mb3JFYWNoKGVsID0+IHRoaXMucmVzdWx0c1BhbmVsLm5hdGl2ZUVsZW1lbnQucmVtb3ZlQ2hpbGQoZWwpKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIHN0YXR1c1xyXG4gICAqIEBwYXJhbSBpc1N0YXJ0IFxyXG4gICAqIEBwYXJhbSBpc0xvYWRpbmcgXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBzdGF0dXMoaXNTdGFydDogYm9vbGVhbiwgaXNMb2FkaW5nOiBib29sZWFuKTogdm9pZCB7XHJcbiAgICB0aGlzLmlzU3RhcnQgPSBpc1N0YXJ0O1xyXG4gICAgdGhpcy5pc0xvYWRpbmcgPSBpc0xvYWRpbmc7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBldmVudEVtaXRcclxuICAgKiBAcGFyYW0gcmVzcG9uc2UgXHJcbiAgICogQHBhcmFtIGVycm9yIFxyXG4gICAqL1xyXG4gIHByaXZhdGUgZXZlbnRFbWl0KHJlc3BvbnNlOiBhbnkgPSBmYWxzZSwgZXJyb3I6IGFueSA9IGZhbHNlKTogdm9pZCB7XHJcbiAgICAocmVzcG9uc2UgIT09IGZhbHNlKSAmJiB0aGlzLmRhdGEubmV4dChyZXNwb25zZSB8fCB7IGRhdGE6IG51bGwgfSk7XHJcbiAgICAocmVzcG9uc2UgIT09IGZhbHNlKSAmJiB0aGlzLmV2ZW50LmVtaXQocmVzcG9uc2UgfHwgeyBkYXRhOiBudWxsIH0pO1xyXG4gICAgKGVycm9yICE9PSBmYWxzZSkgJiYgdGhpcy5lcnJvci5lbWl0KGVycm9yIHx8IG51bGwpO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogU2luZ2xlLXRocmVhZFxyXG4gICAqIExvb3AgUmVjb3JkaW5nIG9uIENhbWVyYVxyXG4gICAqIE11c3QgYmUgZGVzdHJveSByZXF1ZXN0IFxyXG4gICAqIHJlcXVlc3RBbmltYXRpb25GcmFtZVxyXG4gICAqL1xyXG4gIHByaXZhdGUgcmVxdWVzdEFuaW1hdGlvbkZyYW1lKCk6IHZvaWQge1xyXG4gICAgdGhpcy5yQUZfSUQgPSBzZXRJbnRlcnZhbCgoKSA9PiB7XHJcbiAgICAgIGlmICh0aGlzLnZpZGVvLm5hdGl2ZUVsZW1lbnQucmVhZHlTdGF0ZSA9PT0gdGhpcy52aWRlby5uYXRpdmVFbGVtZW50LkhBVkVfRU5PVUdIX0RBVEEpIHtcclxuICAgICAgICB0aGlzLmRyYXdJbWFnZSh0aGlzLnZpZGVvLm5hdGl2ZUVsZW1lbnQpO1xyXG4gICAgICB9XHJcbiAgICB9LCA0MCk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBTdGF0dXMgb2YgY2FtZXJhXHJcbiAgICogQHJldHVybiBib29sZWFuXHJcbiAgICovXHJcbiAgZ2V0IGlzUGF1c2UoKTogYm9vbGVhbiB7XHJcbiAgICByZXR1cm4gdGhpcy5pc1N0YXJ0ICYmIHRoaXMudmlkZW8ubmF0aXZlRWxlbWVudC5wYXVzZWQ7XHJcbiAgfVxyXG5cclxuICBuZ09uRGVzdHJveSgpOiB2b2lkIHtcclxuICAgIHRoaXMucGF1c2UoKTtcclxuICB9XHJcbn0iXX0=